jQuery(function($) {
    
    var term = $("#term").terminal({
        cat: function(fp){
            
            fp = fp.trim() ? fp : "";

            try {
                if (!valid_paths.includes(fp)){throw "invalid";}
                var ext = fp.match(/\.([^.]+)$/)[1];
            } catch(e) {
                term.echo("cat: " + fp + ": No such file or directory");
                return; 
            }

            term.pause();
            $.get(fp).then(file => {
                term.resume();
                term.echo(file.split("\n"));
            });
        },
        cd: function(dir){
            if (dir == "..") {
                devbox.stack.pop();
                return;
            }

            var cwd = devbox.getCurrentWorkingDirectory();
            var item = cwd[dir];
            
            if (!item){
                term.echo("cd: no such file or directory: " + dir);
            } else if (item["type"] != "d"){
                term.echo("cd: not a directory: " + dir);
            } else {
                devbox.stack.push(dir);
            }

        },
        clear: function() {
            term.clear();
        },
        date: function() {
            term.echo(Date());
        },
        id: function() {
            term.echo("uid=0(root) gid=0(root) groups=0(root)");
        },
        less: function(url) {
            url = url.trim() ? url : "";
            try {
                if (!valid_paths.includes(url)){throw "invalid";}
                var ext = url.match(/\.([^.]+)$/)[1];
            } catch(e) {
                term.echo(url + ": No such file or directory")
                return; 
            }
            term.pause();
            $.get(url).then(file => {
                term.resume();
                term.less(file.split("\n"));
            });
        },
        ls: function(...path) {
            var files = "";
            var flags = "";
            var valid_path = true;

            if (path.length == 0){
                path = "";
            }else if (path.length == 1){
                // ls -A
                if (path[0].startsWith("-")){
                    flags = path[0]
                    path = "";
                // ls <dir>
                }else{
                    path = path[0].trim() ? path[0] : "";
                }
            // ls -A <dir>
            }else {        
                flags = path[0] ? path[0].startsWith("-") : "";
                path = path.slice(1, path.length).join(" ").trim() ? path[1] : "";
            }

            // strip off ending slash 
            path = path.endsWith("/") ? path.substring(0, path.length - 1) : path;

            var path_dirs = path.split("/");
            var cwd;
            if (path_dirs.length > 0 && path){
                for(i in path_dirs){
                    cwd = devbox.getCurrentWorkingDirectory();
                    if (!cwd){
                        valid_path = false;
                        break;
                    } else {
                    }
                    var item = cwd[path_dirs[i]];
                    if (!item){
                        valid_path = false;
                    }

                    if (cwd && item){
                        devbox.stack.push(path_dirs[i]);
                    }
                }
            }

            if (!valid_path){
                term.echo("ls: cannot access '"+path+"': No such file or directory");
                return;
            }
            cwd = devbox.getCurrentWorkingDirectory();
            for (i in cwd){
                if (typeof cwd[i] == "object"){
                    term.echo(i);
                }
            }

            // fix stack
            if (path_dirs.length > 0 && path){
                for(d in path_dirs){
                    devbox.stack.pop();
                }
            }
        },
        exit: function() {
            $(".tv").addClass("collapse");
            term.disable();
        },
        pwd: function() {
            term.echo(devbox.stack.join("/"));
        },
        whoami: function() {
            term.echo("root");
        }
    }, {
        checkArity: false,
        completion: true,
        greetings: `
# █▀▀ ▀▄▀ █▀█ █░░ █▀█ █ ▀█▀   █▀▄ █▀▀ █▀ █ █▀▀ █▄░█
# ██▄ █░█ █▀▀ █▄▄ █▄█ █ ░█░   █▄▀ ██▄ ▄█ █ █▄█ █░▀█
#`,
        keydown: function(e) {
            if (anim) {
                return false;
            }
        },
        name: "exploit.design",
        onInit: function(term) {
            set_size();
            var msg = "# Welcome Stranger...\n# Looks like you've managed to gain access to the server.\n# Or have you?\n";
    
            typed_message(term, msg, 50, function(){
                finish = true;
            });

            $("textarea").focus(function() {
                $(window).scrollTop(10);
                var keyboard_shown = $(window).scrollTop() > 0;
                $(window).scrollTop(0);
            }).focus();
        },
        onResize: set_size,
        prompt: function(p){
            var path = devbox.stack.join("/");
            var ps1 = "[[b;#cc6666;]root] [[b;#c5c8c6;]in] [[b;#8abeb7;]"+path+"]\n[[b;#a1b56c;]➜] ";
            p(ps1);
        },
    }).css({
        overflow: "auto"
    });
});
